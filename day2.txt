import asyncio
from typing import List

from fastapi import FastAPI, HTTPException
from pydantic import BaseModel, EmailStr, Field
from databases import Database

# HARD-CODED MySQL connection (inside Docker networks, hostname = mysql)
DATABASE_URL = "mysql+aiomysql://appuser:app123@mysql:3306/myappdb"

app = FastAPI(title="FastAPI + MySQL (Hardcoded Minimal Example)")

database = Database(DATABASE_URL)


# Pydantic Models
class UserOut(BaseModel):
    id: int
    uname: str
    email: EmailStr


# Wait until MySQL is ready
async def wait_for_db():
    for _ in range(20):  # up to ~20 seconds
        try:
            await database.connect()
            await database.fetch_one("SELECT 1")
            return
        except Exception:
            try:
                await database.disconnect()
            except:
                pass
            await asyncio.sleep(1)
    raise RuntimeError("MySQL is not ready")


@app.on_event("startup")
async def startup():
    await wait_for_db()

    # Create table
    await database.execute("""
    CREATE TABLE IF NOT EXISTS users(
        id INT AUTO_INCREMENT PRIMARY KEY,
        uname VARCHAR(100) NOT NULL,
        email VARCHAR(150) NOT NULL
    ) ENGINE=InnoDB;
    """)

    # Insert dummy users only if table empty
    result = await database.fetch_one("SELECT COUNT(*) AS cnt FROM users;")
    if result["cnt"] == 0:
        await database.execute_many(
            "INSERT INTO users (uname, email) VALUES (:uname, :email)",
            [
                {"uname": "Admin", "email": "admin@example.com"},
                {"uname": "Guest", "email": "guest@example.com"},
            ]
        )


@app.on_event("shutdown")
async def shutdown():
    await database.disconnect()


@app.get("/")
async def root():
    return {"message": "FastAPI + MySQL is running with hardcoded config!"}


@app.get("/users", response_model=List[UserOut])
async def get_users():
    rows = await database.fetch_all("SELECT * FROM users;")
    return [{"id": r["id"], "uname": r["uname"], "email": r["email"]} for r in rows]


@app.get("/users/{user_id}", response_model=UserOut)
async def get_user(user_id: int):
    row = await database.fetch_one(
        "SELECT * FROM users WHERE id = :id;",
        values={"id": user_id},
    )
    if not row:
        raise HTTPException(404, "User not found")
    return {"id": row["id"], "uname": row["uname"], "email": row["email"]}



-----

fastapi-mysql-bmc-pune/
├── Dockerfile
├── docker-compose.yml
├── requirements.txt
└── main.py


fastapi
uvicorn[standard]
databases
aiomysql

-------
    
FROM python:3.11-slim

WORKDIR /app

# install build dependencies for aiomysql
RUN apt-get update && \
    apt-get install -y build-essential default-libmysqlclient-dev && \
    rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]




---
version: "3.9"

services:
  api:
    build: .
    container_name: fastapi-mysql-api
    ports:
      - "8000:8000"
    depends_on:
      - mysql
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    container_name: fastapi-mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: myappdb
      MYSQL_USER: appuser
      MYSQL_PASSWORD: bmc123
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"
    restart: unless-stopped

volumes:
  mysql-data:

